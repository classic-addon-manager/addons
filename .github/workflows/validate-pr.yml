name: Validate Pull Request

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Fetch PR head ref
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-head

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Get changed files
        id: changed-files
        run: |
          set -euo pipefail
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_REF=pr-head
          MERGE_BASE=$(git merge-base "$BASE_SHA" "$HEAD_REF")
          echo "Diffing $MERGE_BASE...$HEAD_REF"
          files=$(git diff --name-only "$MERGE_BASE" "$HEAD_REF" | grep -v '^\.github/' | grep -E '\.ya?ml$' || true)
          files=$(echo "$files" | tr '\n' ' ' | sed -e 's/[[:space:]]*$//')
          echo "files=$files" >> $GITHUB_OUTPUT

      - name: Checkout changed files
        if: ${{ steps.changed-files.outputs.files != '' }}
        shell: bash
        run: |
          set -euo pipefail
          files="${{ steps.changed-files.outputs.files }}"
          echo "Checking out files from PR head: $files"
          git checkout pr-head -- $files

      - name: Validate changes
        id: validate
        shell: bash
        run: |
          set -euo pipefail
          # Show the files we're validating
          echo "Files to validate: ${{ steps.changed-files.outputs.files }}"
          # Run validation and capture output
          python .github/validate_addon.py ${{ steps.changed-files.outputs.files }} 2>&1 | tee output.txt
          status=${PIPESTATUS[0]}
          if [ "$status" -ne 0 ]; then exit "$status"; fi
          # Check if there were validation errors in the output
          if grep -q "::error::" output.txt; then
            echo "Found validation errors"
            exit 1
          fi

      - name: Comment on PR on Failure
        if: failure() && steps.validate.outcome == 'failure'
        uses: actions/github-script@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const fs = require('fs');

            // Read the output file
            const output = fs.readFileSync('output.txt', 'utf8');

            // Extract just the error messages
            const errors = output
              .split('\n')
              .filter(line => line.includes('::error::'))
              .map(line => line.replace(/^.*::error::/g, '').trim())
              .filter(line => line && !line.includes('The following issues were found'));

            let comment = '### âŒ Validation Failed\n\n';
            comment += 'The following issues were found in your addon submission:\n\n';
            comment += errors.map(error => `- ${error}`).join('\n');
            comment += '\n\nPlease fix these issues and update your pull request.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
